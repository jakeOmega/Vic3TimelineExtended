# TREATY ARTICLE: request_influence
request_influence = {
	icon = "gfx/interface/icons/diplomatic_treaties_articles_icons/offer_embassy.dds"
    kind = directed
    cost = 500

    flags = {
        can_be_renegotiated
    }

	usage_limit = once_per_side
    
    source_modifier = {
        # Formerly first_modifier, providing leverage to the initiator (source).
        country_treaty_leverage_generation_add = 5000
    }

    visible = {
        always = yes
    }

    possible = {
        is_in_power_bloc = no
        scope:other_country = {
			is_power_bloc_leader = yes
		}
		has_diplomatic_relevance = scope:other_country
        NOT = { has_war_with = scope:other_country }
        NOT = { is_country_type = decentralized }
        NOT = { has_diplomats_expelled = scope:other_country }
        NOT = { scope:other_country = { has_diplomats_expelled = root } }
    }

    can_ratify = {
        custom_tooltip = {
            text = DUPLICATE_ARTICLE_SAME_INPUTS
			NOT = {
				scope:source_country = {
					any_scope_treaty = {
						binds = scope:target_country
						hidden_trigger = {
							OR = {
								scope:treaty = {
									is_renegotiation = no
								}
								scope:treaty.amended_treaty != this
							}
						}
						any_scope_article = {
							has_type = request_influence
							source_country = scope:source_country
						}
					}
				}
			}
        }
    }

    ai = {
        # AI will never offer or request this article.
        article_ai_usage = { none }
        evaluation_chance = { value = 0 }

        inherent_accept_score = {
            value = 0

			if = {
				limit = {
					scope:source_country = this
				}
				add = -1000
			}
			else = {
				add = 30
			}
            if = {
                limit = { has_attitude = { who = scope:source_country attitude = protective } }
                add = 20
            }
            if = {
                limit = { has_attitude = { who = scope:source_country attitude = friendly } }
                add = 10
            }
            if = {
                limit = { scope:source_country.relations:target_country >= relations_threshold:cordial }
                add = 10
            }
        }
    }
}

# TREATY ARTICLE: crisis_resolution
crisis_resolution = {
	icon = "gfx/interface/icons/diplomatic_treaties_articles_icons/offer_embassy.dds"
    kind = directed
    cost = 400
    relations_progress_per_day = 3 
	relations_improvement_max = 80 

	usage_limit = once_per_side

    source_modifier = {
        # The leader (source) pays an authority cost.
        country_authority_add = -100 
    }
    target_modifier = {
        # The target country receives bonuses to handle their crisis.
        country_treaty_leverage_generation_add = 200 
        country_legitimacy_min_add = 40 
        political_movement_radicalism_from_enactment_disapproval_mult = -0.5 
		country_liberty_desire_add = -0.1
    }

    visible = {
        # From old 'selectable'
        is_power_bloc_leader = yes
		power_bloc ?= {
            modifier:power_bloc_can_use_crisis_resolution_bool = yes 
        }
    }

    possible = {
        # From old 'possible'
        authority > 100 
		has_diplomatic_relevance = scope:other_country
        scope:other_country.relations:root > relations_threshold:poor 
        NOT = { has_war_with = scope:other_country } 
    }

    can_ratify = {
		custom_tooltip = {
            text = DUPLICATE_ARTICLE_SAME_INPUTS
			NOT = {
				scope:source_country = {
					any_scope_treaty = {
						binds = scope:target_country
						hidden_trigger = {
							OR = {
								scope:treaty = {
									is_renegotiation = no
								}
								scope:treaty.amended_treaty != this
							}
						}
						any_scope_article = {
							has_type = crisis_resolution
							source_country = scope:source_country
						}
					}
				}
			}
        }
    }

    ai = {
        treaty_categories = { other } # A special support category.
        article_ai_usage = { offer } # The leader offers this aid.

        evaluation_chance = {
            value = 0.0
			if = {
				limit = { country_rank >= rank_value:major_power }
				add = {
					value = country_rank
					multiply = 0.05
				}
			}
        } 

        # AI will propose if the target would accept, mirroring old logic.
        # Since it's unilateral, we assume acceptance is based on need.
        inherent_accept_score = {
            value = 10
            # AI is more likely to propose to countries with turmoil or low legitimacy.
            if = {
                limit = { scope:other_country = { any_scope_state = { turmoil > 25 } } }
                add = 20
            }
            if = {
                limit = { scope:other_country = { legitimacy < 50 } }
                add = 15
            }
            if = {
                limit = { scope:other_country = { has_revolution = yes } }
                add = 30
            }
        }
    }
}

# TREATY ARTICLE: extend_influence
extend_influence = {
	icon = "gfx/interface/icons/diplomatic_treaties_articles_icons/offer_embassy.dds"
    kind = directed
    cost = 500 

    target_modifier = {
        country_treaty_leverage_generation_add = 500 
    }

	usage_limit = once_per_side

    visible = {
        is_power_bloc_leader = yes
		power_bloc ?= {
			modifier:power_bloc_can_use_extend_influence_bool = yes 
		}
    }

    possible = {
        has_diplomatic_relevance = scope:other_country
        NOT = { has_war_with = scope:other_country } 
        NOT = { has_diplomats_expelled = scope:other_country } 
    }

    can_ratify = {
        custom_tooltip = {
            text = DUPLICATE_ARTICLE_SAME_INPUTS
			NOT = {
				scope:source_country = {
					any_scope_treaty = {
						binds = scope:target_country
						hidden_trigger = {
							OR = {
								scope:treaty = {
									is_renegotiation = no
								}
								scope:treaty.amended_treaty != this
							}
						}
						any_scope_article = {
							has_type = crisis_resolution
							source_country = scope:source_country
						}
					}
				}
			}
        }
    }

    non_fulfillment = {
        consequences = withdraw
        conditions = {
            weekly = {
                scope:article = {
                    OR = {
                        root = { has_war_with = scope:other_country }
                        root = { has_diplomats_expelled = scope:other_country }
                    }
                }
            }
        }
    }

    ai = {
        treaty_categories = { power_bloc }
        article_ai_usage = { offer }
        evaluation_chance = { value = 0.25 } 

        inherent_accept_score = {
            # Based on old 'propose_score' logic 
            value = -5
            if = {
                limit = { root = { has_attitude = { who = scope:other_country attitude = protective } } }
                add = 20
            }
            if = {
                limit = { root = { has_attitude = { who = scope:other_country attitude = conciliatory } } }
                add = 20
            }
            if = {
                limit = { root = { has_attitude = { who = scope:other_country attitude = friendly } } }
                add = 10
            }
        }
    }
}

# ---------------------------------
# TREATY ARTICLE: education_aid
# ---------------------------------
# This article allows a country to provide educational support to another,
# boosting their education access. It is based on the original 'education_aid' diplomatic action.
education_aid = {
	icon = "gfx/interface/icons/diplomatic_treaties_articles_icons/offer_embassy.dds"
	kind = directed
	cost = 100 
	relations_progress_per_day = 3 
	relations_improvement_max = 30 

	# This modifier applies to the country receiving aid (the target).
	target_modifier = {
		country_treaty_leverage_generation_add = 200 
		state_education_access_add = 0.1 
	}

	source_modifier = {
		country_institution_cost_institution_schools_mult = 0.1
	}

	usage_limit = once_per_side

	# This article is only visible if the potential provider has unlocked it via their power bloc.
	visible = {
		power_bloc ?= {
			modifier:power_bloc_can_give_education_aid_bool = yes 
		}
	}

	possible = {
		country_rank > scope:other_country.country_rank 
		literacy_rate > scope:other_country.literacy_rate 
		scope:other_country = {
			OR = {
				has_law = law_type:law_no_schools 
				institution_investment_level = {
					institution = institution_schools
					value <= 3 
				}
			}
		}
	}

	# The initial requirements for the pact to be established.
	can_ratify = {
		custom_tooltip = {
            text = DUPLICATE_ARTICLE_SAME_INPUTS
			NOT = {
				scope:source_country = {
					any_scope_treaty = {
						binds = scope:target_country
						hidden_trigger = {
							OR = {
								scope:treaty = {
									is_renegotiation = no
								}
								scope:treaty.amended_treaty != this
							}
						}
						any_scope_article = {
							has_type = education_aid
							source_country = scope:source_country
						}
					}
				}
			}
        }
	}


	ai = {
		treaty_categories = { other }
		article_ai_usage = { offer }
		evaluation_chance = {
			value = 10.0
			if = {
				limit = { country_rank >= rank_value:major_power } 
				add = {
					value = country_rank
					multiply = 0.05 
				}
			}
		}
		inherent_accept_score = {
            value = 10
            if = {
                limit = { scope:target_country = { literacy_rate < 0.2 } }
                add = 20
            }
            if = {
                limit = { scope:target_country = { institution_investment_level = { institution = institution_schools value < 2 } } }
                add = 15
            }
        }
	}
}

# ---------------------------------
# TREATY ARTICLE: healthcare_aid
# ---------------------------------
# This article allows a country to provide healthcare support, improving mortality and SoL.
# It is based on the original 'healthcare_aid' diplomatic action.
healthcare_aid = {
	icon = "gfx/interface/icons/diplomatic_treaties_articles_icons/offer_embassy.dds"
	kind = directed
	cost = 100 
	relations_progress_per_day = 3 
	relations_improvement_max = 30 

	source_modifier = {
		country_institution_cost_institution_health_system_mult = 0.1
	}

	target_modifier = {
		country_treaty_leverage_generation_add = 200 
		state_mortality_mult = -0.05
		state_standard_of_living_add = 1
	}

	usage_limit = once_per_side

	visible = {
		power_bloc ?= {
			modifier:power_bloc_can_give_healthcare_aid_bool = yes 
		}
	}

	possible = {
		country_rank > scope:other_country.country_rank 
		institution_investment_level = {
			institution = institution_health_system
			value >= 3 
		}
		scope:other_country = {
			OR = {
				has_law = law_type:law_no_health_system 
				institution_investment_level = {
					institution = institution_health_system
					value <= 3 
				}
			}
		}
	}

	can_ratify = {
		custom_tooltip = {
            text = DUPLICATE_ARTICLE_SAME_INPUTS
			NOT = {
				scope:source_country = {
					any_scope_treaty = {
						binds = scope:target_country
						hidden_trigger = {
							OR = {
								scope:treaty = {
									is_renegotiation = no
								}
								scope:treaty.amended_treaty != this
							}
						}
						any_scope_article = {
							has_type = education_aid
							source_country = scope:source_country
						}
					}
				}
			}
        }
	}

	ai = {
		treaty_categories = { other }
		article_ai_usage = { offer }
		evaluation_chance = {
			value = 10.0
			if = {
				limit = { country_rank >= rank_value:major_power } 
				add = {
					value = country_rank
					multiply = 0.05 
				}
			}
		}
		inherent_accept_score = {
            value = 10
            if = {
                limit = { scope:target_country = { average_sol_for_primary_cultures < 10 } }
                add = 20
            }
            if = {
                limit = { scope:target_country = { institution_investment_level = { institution = institution_health_system value < 2 } } }
                add = 15
            }
        }
	}
}


# ---------------------------------
# TREATY ARTICLE: security_aid
# ---------------------------------
# This article allows a country to provide security assistance to reduce turmoil.
# It is based on the original 'security_aid' diplomatic action.
security_aid = {
	icon = "gfx/interface/icons/diplomatic_treaties_articles_icons/offer_embassy.dds"
	kind = directed
	cost = 100 
	relations_progress_per_day = 3 
	relations_improvement_max = 30 

	source_modifier = {
		country_institution_cost_institution_police_mult = 0.1
	}

	target_modifier = {
		country_treaty_leverage_generation_add = 200 
		state_turmoil_effects_mult = -0.2 
		country_liberty_desire_add = -0.1
	}

	usage_limit = once_per_side

	visible = {
		power_bloc ?= {
			modifier:power_bloc_can_give_security_aid_bool = yes 
		}
	}

	possible = {
		country_rank > scope:other_country.country_rank 
		institution_investment_level = {
			institution = institution_police
			value >= 3 
		}
		scope:other_country = {
			OR = {
				has_law = law_type:law_no_police 
				institution_investment_level = {
					institution = institution_police
					value <= 3 
				}
			}
		}
	}

	can_ratify = {
		custom_tooltip = {
			text = DUPLICATE_ARTICLE_SAME_INPUTS
			NOT = {
				scope:source_country = {
					any_scope_treaty = {
						binds = scope:target_country
						hidden_trigger = {
							OR = {
								scope:treaty = {
									is_renegotiation = no
								}
								scope:treaty.amended_treaty != this
							}
						}
						any_scope_article = {
							has_type = security_aid
							source_country = scope:source_country
						}
					}
				}
			}
		}
	}

	ai = {
		treaty_categories = { other }
		article_ai_usage = { offer }
		evaluation_chance = {
			value = 10.0
			if = {
				limit = { country_rank >= rank_value:major_power } 
				add = {
					value = country_rank
					multiply = 0.05 
				}
			}
		}
		inherent_accept_score = {
            value = 10
            if = {
                limit = { scope:target_country = { any_scope_state = { turmoil > 25 } } }
                add = 20
            }
            if = {
                limit = { scope:target_country = { has_revolution = yes } }
                add = 30
            }
        }
	}
}

# ---------------------------------
# TREATY ARTICLE: science_aid
# ---------------------------------
# This article allows a technologically advanced country to provide scientific support,
# boosting tech spread at a cost to their own innovation.
# It is based on the original 'science_aid' diplomatic action.
science_aid = {
	icon = "gfx/interface/icons/diplomatic_treaties_articles_icons/offer_embassy.dds"
	kind = directed
	cost = 100 
	relations_progress_per_day = 3 
	relations_improvement_max = 30 

	usage_limit = once_per_side

	source_modifier = {
		country_weekly_innovation_add = -100
	}
	target_modifier = {
		country_treaty_leverage_generation_add = 200
		country_tech_spread_add = 100
	}

	visible = {
		power_bloc ?= {
			modifier:power_bloc_can_give_science_aid_bool = yes 
		}
	}

	possible = {
		root.techs_researched > scope:other_country.techs_researched 
		root.country_rank > scope:other_country.country_rank 
		institution_investment_level = {
			institution = institution_ministry_of_science
			value >= 2 
		}
	}

	can_ratify = {
		custom_tooltip = {
			text = DUPLICATE_ARTICLE_SAME_INPUTS
			NOT = {
				scope:source_country = {
					any_scope_treaty = {
						binds = scope:target_country
						hidden_trigger = {
							OR = {
								scope:treaty = {
									is_renegotiation = no
								}
								scope:treaty.amended_treaty != this
							}
						}
						any_scope_article = {
							has_type = science_aid
							source_country = scope:source_country
						}
					}
				}
			}
		}
	}

	ai = {
		treaty_categories = { none }
		article_ai_usage = {
            request
        }

		evaluation_chance = {
			value = 10.0
			if = {
				limit = { country_rank >= rank_value:major_power } 
				add = {
					value = country_rank
					multiply = 0.05 
				}
			}
		}
		inherent_accept_score = {
            value = 10
            if = {
                limit = { scope:target_country = { country_innovation < 100 } }
                add = 20
            }
            if = {
                limit = { scope:target_country = { modifier:country_tech_spread_add < 100 } }
                add = 15
            }
        }
	}
}

# ---------------------------------
# TREATY ARTICLE: science_aid_2
# ---------------------------------
# An upgraded version of Science Aid, providing greater benefits at a higher cost.
# It requires the base 'science_aid' article to already be active.
science_aid_2 = {
	icon = "gfx/interface/icons/diplomatic_treaties_articles_icons/offer_embassy.dds"
	kind = directed
	cost = 100 
	relations_progress_per_day = 6 
	relations_improvement_max = 30 

	usage_limit = once_per_side

	source_modifier = {
		country_weekly_innovation_add = -400 
	}
	target_modifier = {
		country_treaty_leverage_generation_add = 400 
		country_tech_spread_add = 400 
	}

	visible = {
		power_bloc ?= {
			modifier:power_bloc_can_give_science_aid_2_bool = yes 
		}
	}

	possible = {
		# This upgraded pact requires the original to be active between the two countries.
		# This is checked by looking for an existing treaty with the 'science_aid' article.
        custom_tooltip = {
            text = REQ_BASE_SCIENCE_AID_ARTICLE
            any_scope_treaty = {
                binds = scope:other_country
                any_scope_article = {
                    has_type = science_aid
                    source_country = root
                }
            }
        }

		techs_researched > scope:other_country.techs_researched 
		country_rank > scope:other_country.country_rank 
		institution_investment_level = {
			institution = institution_ministry_of_science
			value >= 4 
		}
	}

	can_ratify = {
		custom_tooltip = {
			text = DUPLICATE_ARTICLE_SAME_INPUTS
			NOT = {
				scope:source_country = {
					any_scope_treaty = {
						binds = scope:target_country
						hidden_trigger = {
							OR = {
								scope:treaty = {
									is_renegotiation = no
								}
								scope:treaty.amended_treaty != this
							}
						}
						any_scope_article = {
							has_type = science_aid_2
							source_country = scope:source_country
						}
					}
				}
			}
		}
	}

	ai = {
		treaty_categories = { other }
		article_ai_usage = { offer }
		evaluation_chance = {
			value = 20.0
			if = {
				limit = { country_rank >= rank_value:major_power } 
				add = {
					value = country_rank
					multiply = 0.05 
				}
			}
		}
		inherent_accept_score = {
            value = 20
            if = {
                limit = { scope:target_country = { country_innovation < 400 } }
                add = 30
            }
            if = {
                limit = { scope:target_country = { modifier:country_tech_spread_add < 400 } }
                add = 25
            }
        }
	}
}

# ---------------------------------
# TREATY ARTICLE: suppress_subject_liberty
# ---------------------------------
# This article allows an overlord to suppress the liberty desire of their subject.
suppress_subject_liberty = {
	icon = "gfx/interface/icons/diplomatic_treaties_articles_icons/offer_embassy.dds"
	kind = directed
	cost = 100

	source_modifier = {
		country_liberty_desire_add = -0.25
	}

	usage_limit = once_per_side

	visible = {
		NOT = { is_country_type = decentralized }
		is_revolutionary = no
	}

	possible = {
		is_subject_of = scope:other_country
	}

	can_ratify = {
		always = yes
	}

	ai = {
		treaty_categories = { power_bloc }
		article_ai_usage = { offer request }
		evaluation_chance = {
			value = 10.0
			if = {
				limit = { has_attitude = { who = scope:other_country attitude = domineering } }
				add = 20
			}
		}
		inherent_accept_score = {
			value = 0
			if = {
				limit = { scope:target_country = this } # Evaluator is the Overlord (source)
				add = 50 # Overlords like this
				if = {
					limit = { scope:target_country = { has_attitude = { who = root attitude = rebellious } } }
					add = 25
				}
			}
			else = {
				add = -50 # Subjects do not like this
				if = {
					limit = { scope:source_country.relations:target_country >= relations_threshold:cordial }
					add = 10
				}
				if = {
					limit = { scope:source_country.relations:target_country >= relations_threshold:friendly }
					add = 10
				}
				if = {
					limit = { has_attitude = { who = scope:source_country attitude = loyal } }
					add = 15
				}
			}
		}
	}
}

# ---------------------------------
# TREATY ARTICLE: nuclear_disarmament
# ---------------------------------
# This article forces a country to dismantle its nuclear program.
nuclear_disarmament = {
	icon = "gfx/interface/icons/diplomatic_treaties_articles_icons/offer_embassy.dds"
	kind = directed
	cost = 200

	flags = { can_be_enforced }

	usage_limit = once_per_side

	visible = {
		has_technology_researched = nuclear_weapons
	}

	possible = {
		scope:other_country = { has_technology_researched = nuclear_weapons }
	}

	can_ratify = {
		custom_tooltip = {
			text = DUPLICATE_ARTICLE_SAME_INPUTS
			NOT = {
				scope:source_country = {
					any_scope_treaty = {
						binds = scope:target_country
						hidden_trigger = {
							OR = {
								scope:treaty = {
									is_renegotiation = no
								}
								scope:treaty.amended_treaty != this
							}
						}
						any_scope_article = {
							has_type = nuclear_disarmament
							source_country = scope:source_country
						}
					}
				}
			}
		}
	}

	ai = {
		treaty_categories = { other }
		article_ai_usage = { request }
		evaluation_chance = {
			value = 5.0
			if = {
				limit = { has_attitude = { who = scope:other_country attitude = hostile } }
				add = 10
			}
			if = {
				limit = { any_rival_country = { THIS = scope:other_country } }
				add = 20
			}
		}
		inherent_accept_score = {
			value = 0
			if = {
				limit = { scope:target_country = this } # Evaluator is the one demanding disarmament (source)
				add = 75 # Countries want their rivals disarmed
				if = {
					limit = { has_attitude = { who = scope:target_country attitude = hostile } }
					add = 25
				}
			}
			else = { # Evaluator is the one being asked to disarm (target)
				add = -100
				if = {
					limit = { country_rank >= rank_value:great_power }
					add = -50
				}
				if = {
					limit = { scope:source_country.relations:target_country < relations_threshold:cordial }
					add = -50
				}
				if = {
					limit = { any_rival_country = { THIS = scope:source_country } }
					add = -100
				}
			}
		}
	}
}

# ---------------------------------
# TREATY ARTICLE: nuclear_program_aid
# ---------------------------------
# This article allows a country to provide nuclear program aid to another,
# allowing them to develop nuclear weapons.
nuclear_program_aid = {
	icon = "gfx/interface/icons/diplomatic_treaties_articles_icons/offer_embassy.dds"
	kind = directed
	cost = 500

	target_modifier = {
		receiving_nuclear_program_aid = yes
	}

	usage_limit = once_per_side

	visible = {
		has_modifier = nuclear_power
	}

	possible = {
		has_modifier = nuclear_power
		scope:other_country = {
			NOT = { has_modifier = nuclear_power }
			NOT = {
				any_scope_treaty = {
					any_scope_article = {
						has_type = nuclear_disarmament
						target_country = root
					}
				}
			}
		}
	}

	can_ratify = {
		custom_tooltip = {
			text = DUPLICATE_ARTICLE_SAME_INPUTS
			NOT = {
				scope:source_country = {
					any_scope_treaty = {
						binds = scope:target_country
						hidden_trigger = {
							OR = {
								scope:treaty = {
									is_renegotiation = no
								}
								scope:treaty.amended_treaty != this
							}
						}
						any_scope_article = {
							has_type = nuclear_program_aid
							source_country = scope:source_country
						}
					}
				}
			}
		}
	}

	ai = {
		treaty_categories = { other }
		article_ai_usage = { offer }
		evaluation_chance = {
			value = 5.0
			if = {
				limit = { has_attitude = { who = scope:other_country attitude = friendly } }
				add = 10
			}
			if = {
				limit = { is_in_same_power_bloc = scope:other_country }
				add = 20
			}
		}
		inherent_accept_score = {
			value = 0
			if = {
				limit = { scope:target_country = this } # Evaluator is the one offering aid (source)
				add = -100
				if = {
					limit = { is_in_same_power_bloc = scope:target_country }
					add = 25
				}
				if = {
					limit = { has_attitude = { who = scope:target_country attitude = friendly } }
					add = 25
				}
				if = {
					limit = { scope:source_country.relations:target_country >= relations_threshold:cordial }
					add = 25
				}
				if = {
					limit = {
						"num_shared_rivals(scope:target_country)" > 0
					}
					add = 25
				}
				if = {
					limit = {
						"num_alliances_and_defensive_pacts_with_rivals(scope:source_country)" > 0
					}
					add = {
						desc = "DIPLOMATIC_ACCEPTANCE_ALLIED_TO_RIVALS"
						value = "num_alliances_and_defensive_pacts_with_rivals(scope:source_country)"
						multiply = -15
					}
				}

				if = {
					limit = {
						"num_alliances_and_defensive_pacts_with_allies(scope:source_country)" > 0
					}
					add = {
						desc = "DIPLOMATIC_ACCEPTANCE_ALLIED_TO_ALLIES"
						value = "num_alliances_and_defensive_pacts_with_allies(scope:source_country)"
						multiply = 10
					}
				}
			}
			else = { # Evaluator is the one being asked to accept aid (target)
				add = 50
				if = {
					limit = { country_rank >= rank_value:major_power }
					add = 50
				}
				if = {
					limit = { scope:source_country.relations:target_country > relations_threshold:cordial }
					add = 25
				}
			}
		}
	}
}

# TREATY ARTICLE: intelligence_sharing_pact
intelligence_sharing_pact = {
    kind = mutual
    cost = 200  # Upfront Influence cost

    # Improves relations over time, showing growing trust.
    relations_progress_per_day = 1.0
    relations_improvement_max = 60

	usage_limit = once_per_treaty

	mutual_exclusions = {
		intelligence_sharing_pact
	}

    icon = "gfx/interface/icons/diplomatic_treaties_articles_icons/offer_embassy.dds"

    flags = {
        can_be_renegotiated
    }

	unlocked_by_technologies = {
        intergovernmental_organizations
    }

    # Mutual modifier applies to both signatories.
    mutual_modifier = {
        # The core benefit: a 20% boost to the institution's effectiveness.
        country_institution_impact_institution_ministry_of_intelligence_and_security_mult = 0.20

        # The trade-off: a 10% increase in Bureaucracy cost.
        country_institution_cost_institution_ministry_of_intelligence_and_security_mult = 0.10

        # The second trade-off: a continuous drain on Authority.
        country_authority_add = -50

        # Represents the mutual dependence and entanglement of the pact.
        country_treaty_leverage_generation_add = 300

        # A passive benefit representing shared counter-intelligence.
        country_leverage_resistance_mult = 0.1
    }

    # Executed once when the treaty is signed.
    on_entry_into_force = {
        # The world takes notice of this deep alliance, generating a small amount of Infamy.
        scope:article_options.first_country = {
			change_infamy = 1
		}
        scope:article_options.second_country = {
			change_infamy = 1
		}
    }

    # Only visible and possible between significant powers who have something to share.
    visible = {
        has_law = law_type:law_ministry_of_intelligence_and_security

		# Don't already have same article in existing treaty
		NOT = {
			scope:source_country = {
				any_scope_treaty = {
					binds = scope:target_country
					hidden_trigger = {
						OR = {
							scope:treaty = {
								is_renegotiation = no
							}
							scope:treaty.amended_treaty != this
						}
					}
					any_scope_article = {
						has_type = intelligence_sharing_pact
						source_country = scope:source_country
					}
				}
			}
		}
	}

    possible = {
        # Both countries must have a spy agency to share intelligence.
        has_law = law_type:law_ministry_of_intelligence_and_security
        scope:other_country = { has_law = law_type:law_ministry_of_intelligence_and_security }

        # Must be at least a Major Power to enter such a high-level agreement.
        country_rank >= rank_value:major_power
        scope:other_country = { country_rank >= rank_value:major_power }

        # Standard diplomatic checks
        has_diplomatic_relevance = scope:other_country
        NOT = { has_war_with = scope:other_country }
        NOT = { has_diplomats_expelled = scope:other_country }
        NOT = { scope:other_country = { has_diplomats_expelled = root } }
    }

    can_ratify = {
        always = yes
    }

    ai = {
        treaty_categories = { military }
        article_ai_usage = { offer request }
        evaluation_chance = { value = 15.0 }

        inherent_accept_score = {
            value = 0
            # AI is more willing if they have good relations or a common threat.
            if = {
                limit = { has_attitude = { who = scope:other_country attitude = friendly } }
                add = 25
            }
            if = {
                limit = { any_rival_country = { any_rival_country = {THIS = scope:other_country } } } # We have a rival in common
                add = 40
            }
            # AI is less willing if they have conflicting interests or are rivals.
            if = {
                limit = { any_rival_country = { THIS = scope:other_country } }
                add = -100
            }
            if = {
                limit = { has_attitude = { who = scope:other_country attitude = hostile } }
                add = -50
            }
        }
    }
}

# TREATY ARTICLE: joint_military_exercises
joint_military_exercises = {
    kind = mutual
    cost = 75 # Relatively low influence cost, making it an accessible agreement

    # The act of training together builds trust and improves relations.
    relations_progress_per_day = 0.5
    relations_improvement_max = 30

	usage_limit = once_per_treaty

	mutual_exclusions = {
		joint_military_exercises
	}

    icon = "gfx/interface/icons/diplomatic_treaties_articles_icons/offer_embassy.dds"

    flags = {
        can_be_renegotiated
    }

    # Unlocks once modern combined arms doctrines are understood.
    unlocked_by_technologies = {
        combined_arms
    }

    # Mutual modifier applies to both signatories.
    mutual_modifier = {
        # The core benefit: Armies gain experience faster.
        unit_army_experience_gain_mult = 0.25
        unit_navy_experience_gain_mult = 0.25

        # The trade-off: A small increase in military goods cost, representing the ammunition, fuel,
        # and equipment consumed during large-scale training exercises.
        country_military_goods_cost_mult = 0.05

        # Represents the diplomatic entanglement of the pact.
        country_treaty_leverage_generation_add = 150
    }

    # No special visibility requirements beyond having the tech.
    visible = {
        NOT = { is_country_type = decentralized }
		has_technology_researched = combined_arms

		# Don't already have same article in existing treaty
		NOT = {
			scope:source_country = {
				any_scope_treaty = {
					binds = scope:target_country
					hidden_trigger = {
						OR = {
							scope:treaty = {
								is_renegotiation = no
							}
							scope:treaty.amended_treaty != this
						}
					}
					any_scope_article = {
						has_type = joint_military_exercises
						source_country = scope:source_country
					}
				}
			}
		}
	}

    possible = {
        # Standard diplomatic checks
        has_diplomatic_relevance = scope:other_country
        NOT = { has_war_with = scope:other_country }
        NOT = { has_diplomats_expelled = scope:other_country }
        NOT = { scope:other_country = { has_diplomats_expelled = root } }
    }

    can_ratify = {
        always = yes
    }

    ai = {
        treaty_categories = { military }
        article_ai_usage = { offer request }
        evaluation_chance = { value = 20.0 } # AI should propose this fairly often to allies.

        inherent_accept_score = {
            value = 10
            # AI is more willing if they have good relations or a common threat.
            if = {
                limit = { has_attitude = { who = scope:other_country attitude = friendly } }
                add = 30
            }
            if = {
                limit = { any_rival_country = { any_rival_country = {THIS = scope:other_country } } } # Common rival
                add = 30
            }
            # AI is less willing if they are rivals.
            if = {
                limit = { any_rival_country = { THIS = scope:other_country } }
                add = -75
            }
            # AI is more likely to accept if they have a Jingoist or militaristic leader/government.
            if = {
                limit = {
                    OR = {
						any_interest_group = {
							OR = {
								has_ideology = ideology:ideology_jingoist
								has_ideology = ideology:ideology_fascist
							}
							is_in_government = yes
						}
                    }
                }
                add = 20
            }
        }
    }
}